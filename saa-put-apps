#!/bin/bash
pname=$(basename "$0")
dname=$(dirname "$0")
usage="$pname [{-s|--saadir} SaaDir] [{-t|--target} {apk|ab|apk,ab}] [-l|--list|-q|--quiet|-v|--verbose|-n|--dryrun|--log|--nolog]
$pname [-h|--help]
Features:
  Put (or list) programs (apk files) or data (adb backups or raw /data directory images) files
  to a remote Android device using adb command.
  Putting entity (programs and data) have to be stored to the 'apps' directory, which is a child
  of SaaDir directory specified by -s|--saadir.
  If a entity is already in a remote Android device, no entity is put or list.

Options:
  -s|--saadir SaaDir
    Specify a directory in which putting 
  -t|--target {apk|ab|apk,ab}
    Target entities to put to a remote Android device. Default is apk,ab.
  -l|--list
    Instead of putting entities, List entities to be put to a remote Android device.
  -q|--quiet
    No messages are displayed, except error message.
  -v|--verbose
    Additional messages are displayed. It has precedence over -q|--quiet|-s|--silent.
  -n|--dryrun
    Only messages displayed, No SAADirectory is made.
  --log
    Logging almost all messages to logfiles. It is a default.
  --nolog
    No log files created. It is a default when -n|--dryrun or -l|--list.
  -h|--help
    This help message is displayed."

source "$dname/run.sh"

targets='apk,ab'
listp=false
quietp=false
verbosep=false
dryrunp=false
nologp=false
while true; do
  case "$1" in
  -s|--saadir) SAADIR="$2"; shift 2;;
  -t|--target) targets="$2"; shift 2;;
  -l|--list) listp=true; shift;;
  -q|--quiet) quietp=true; shift;;
  -v|--verbose) verbosep=true; shift;;
  -n|--dryrun) dryrunp=true; verbosep=true; nologp=true; shift;;
  --log) nologp=false; shift;;
  --nolog) nologp=true; shift;;
  -*) echo "$usage"; exit 1;;
  *) break;;
  esac
done
targets=$(IFS=$' \t\n,'; echo $targets)
test $# -ne 0 && { echo "$usage"; exit 1;}

case "$dname" in /*);; *) dname="$(pwd)/$dname";; esac

adev="$(adb devices -l)"
dev=$(echo "$adev" | adb-parsedev -b -o -r -s -u model) || exit 11
stamp=$(date +%Y%m%d-%H%M%S)
log="log-$dev-$stamp-put"
$listp && log="log-$dev-$stamp-putlist"
$nologp && log=/dev/null

(
  $quietp || echo "device: $dev">&2
  $quietp || echo "timestamp: $stamp">&2
  $quietp || echo "SAADIR=$SAADIR">&2
  pkglist=@list
  blacklist=@blacklist
  pkgondev=@pkgondev
  pkgtoput=@pkgtoput
  #filetoput=@filetoput

  test -z "$SAADIR" && { echo "Please set envvar: SAADIR or use -s|--saadir option.">&2; exit 2;}
  cd "$SAADIR"
  appsdir=apps
  appsdir_escaped="$appsdir"  # TODO: to be regexp escaped
  test -d "$appsdir" ||
    { echo "$appsdir: no such a (applications) directory.">&2; exit 3;}
  test -r "$pkglist" ||
    { echo "$pkglist: no such a (packages list) file.">&2; exit 4;}

  $quietp || { echo; echo "**** compute supplements based on packages."; }>&2
  tPkgtoput_candidate=$(mktemp $pname.XXXXXXXX)
  trap "rm -f '$tPkgtoput_candidate'" 1 2 3 15 EXIT ERR
  $quietp || echo "make $pkgondev: pkgs-list on the device.">&2
  get-android-apps list -3 >"$pkgondev" ||
    { echo "get-android-apps -list: failed.">&2; rm -f "$pkgondev"; exit 5;}
  $quietp || echo "make $pkgtoput: list of pkgs to put (exist on the saadir but not on the device).">&2
  set-complement "$pkglist" "$pkgondev" >"$tPkgtoput_candidate" ||
    { echo "make $pkgtoput: failed.">&2;  exit 6;}
  if test -r "$blacklist"; then
    $quietp || echo "apply blacklist $blacklist to $pkgtoput.">&2
    set-complement "$tPkgtoput_candidate" "$blacklist" >"$pkgtoput" ||
      { echo "apply $blacklist: failed.">&2; rm -f "$pkgtoput"; exit 7;}
    rm -f "$tPkgtoput_candidate"
  else
    mv "$tPkgtoput_candidate" "$pkgtoput"
  fi
  trap - 1 2 3 15 EXIT ERR

  if $listp; then
    echo -------- Packages to put:
    cat "$pkgtoput"
    echo -------- end of Packages to put:
    rm "$pkgtoput"
  else
    if test $(cat "$pkgtoput" | wc -l) -eq 0; then
      $quietp || echo "No packages to put.">&2
    else
      
      for obj in $targets; do
        $quietp || echo "put $obj files of $pkgtoput pkgs.">&2
        case $obj in
        apk)
          unset files
          for pkg in $(cat $pkgtoput); do
            apks=$(ls "$appsdir"/$pkg.apk "$appsdir"/$pkg-*.apk 2>/dev/null)
            if [ "$apks" = "" ]; then
              echo "$pkg: no apk-files for the package.">&2
            else
              files="$files${files:+ }$apks"
            fi
          done
          ;;
        *)
          files=$(sed "s|^|$appsdir_escaped/|;s|$|.$obj|" "$pkgtoput")
          ;;
        esac
        run put-android-apps $obj $files
      done
      
      if $dryrunp; then
        rm "$pkgtoput"
      else
        mv "$pkgtoput" "$pkgtoput-$stamp-$dev"
      fi
    fi
  fi

  if $listp || $dryrunp; then
    rm "$pkgondev"
  else
    cp -p "$pkglist" "$pkglist-$stamp-post_$dev"
    mv "$pkgondev" "$pkgondev-$dev-$stamp"
    "$dname"/saa-make-list ||
      { echo "saa-make-list: failed.">&2; exit 32;}
    #"$dname"/saa-make-desc
  fi
) 2>&1 | tee "$log"
